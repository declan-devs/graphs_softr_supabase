<script>
  async function loadData() {
    console.log("[loadData] Starting data load...");

    try {
      const url = "https://qqdcnlmlzfhugkndkrnz.supabase.co/functions/v1/bright-function";
      console.log(`[loadData] Fetching from URL: ${url}`);

      const response = await fetch(url);
      console.log(`[loadData] Fetch response status: ${response.status}`);

      if (!response.ok) {
        console.error(`[loadData] Fetch failed. Status: ${response.status} ${response.statusText}`);
        const text = await response.text();
        console.warn("[loadData] Response text for debugging:", text);
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const json = await response.json();
      console.log("[loadData] Fetched JSON data:", json);

      const data = Array.isArray(json) ? json : json.data || [];

      if (!Array.isArray(data) || data.length === 0) {
        console.warn("[loadData] Data format issue or no data found:", data);
        throw new Error("Data is not in expected array format.");
      }

      console.log("[loadData] Parsed data. First row sample:", data[0]);

      const dates = data.map(row => row.ts || row.date); // support both field names
      const val1 = data.map(row => row.val_1);
      const val2 = data.map(row => row.val_2);

      console.log("[loadData] Mapped fields: dates, val_1, val_2");

      const trace1 = {
        x: dates,
        y: val1,
        name: 'val_1',
        type: 'scatter',
        yaxis: 'y1',
        line: { color: 'blue' }
      };

      const trace2 = {
        x: dates,
        y: val2,
        name: 'val_2',
        type: 'scatter',
        yaxis: 'y2',
        line: { color: 'orange' }
      };

      const layout = {
        title: 'Dual Axis Line Chart (val_1 vs val_2)',
        xaxis: { title: 'Date' },
        yaxis: {
          title: 'val_1',
          titlefont: { color: 'blue' },
          tickfont: { color: 'blue' }
        },
        yaxis2: {
          title: 'val_2',
          titlefont: { color: 'orange' },
          tickfont: { color: 'orange' },
          overlaying: 'y',
          side: 'right'
        },
        legend: { x: 0, y: 1.1, orientation: 'h' }
      };

      console.log("[loadData] Plotting with Plotly...");
      Plotly.newPlot('plot', [trace1, trace2], layout);
      console.log("[loadData] Plot complete.");
    } catch (error) {
      console.error("Failed to load data or plot graph:", error);
      document.getElementById('plot').innerText = "Error loading graph. Check console for details.";
    }
  }

  loadData();
</script>
